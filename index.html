<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ Ù…Ø±ØºØ¯Ø§Ø±ÛŒ | Ú†Øª Ø¨Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø´Ù…Ø§ */
        .date-header {
            background: white;
            border-radius: 50px;
            padding: 10px 20px;
            display: inline-block;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            color: #333;
            font-weight: 500;
        }

        .date-header i {
            color: #667eea;
            margin-left: 8px;
        }

        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¨Ø®Ø´ Ú†Øª Ø¨Ø§Øª */
        .chat-section {
            margin-top: 50px;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            color: white;
        }

        .chat-section h2 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .chat-container {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .user-message {
            align-items: flex-start;
        }

        .assistant-message {
            align-items: flex-end;
        }

        .message-bubble {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 20px;
            word-wrap: break-word;
            font-size: 1rem;
            line-height: 1.5;
        }

        .user-message .message-bubble {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 5px;
        }

        .assistant-message .message-bubble {
            background: #e9ecef;
            color: #333;
            border-bottom-left-radius: 5px;
        }

        .input-area {
            display: flex;
            gap: 10px;
            background: white;
            padding: 10px;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        #messageInput {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            outline: none;
            font-family: 'Vazirmatn', sans-serif;
        }

        #sendBtn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        #sendBtn:hover:not(:disabled) {
            transform: scale(1.05);
        }

        #sendBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .chat-controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
        }

        .clear-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.5);
            padding: 8px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .clear-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            color: #666;
            justify-content: center;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø±ÛŒØ³Ù¾Ø§Ù†Ø³ÛŒÙˆ */
        @media (max-width: 768px) {
            .input-area {
                flex-direction: column;
                border-radius: 20px;
            }
            
            #sendBtn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="date-header">
                <i>ğŸ“…</i> Ø§Ù…Ø±ÙˆØ²: <span id="jalaliDate">Û±Û´Û°Û²/Û±Û²/Û°Û±</span>
            </div>
            <h1>ğŸ§® Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ ØªØ®ØµØµÛŒ Ù…Ø±ØºØ¯Ø§Ø±ÛŒ</h1>
            <p>Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ù‚ÛŒÙ‚ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ù¾Ø±ÙˆØ±Ø´ Ø·ÛŒÙˆØ±</p>
        </header>

        <div class="cards-grid">
            <!-- Ú©Ø§Ø±Øª Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ Ø¶Ø±ÛŒØ¨ ØªØ¨Ø¯ÛŒÙ„ -->
            <div class="card">
                <div class="card-icon">ğŸ“Š</div>
                <h2>Ø¶Ø±ÛŒØ¨ ØªØ¨Ø¯ÛŒÙ„ ØºØ°Ø§ÛŒÛŒ (FCR)</h2>
                <p>Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¶Ø±ÛŒØ¨ ØªØ¨Ø¯ÛŒÙ„ Ø®ÙˆØ±Ø§Ú© Ø¨Ù‡ Ú¯ÙˆØ´Øª</p>
                <a href="pages/fcr-calculator.html" class="btn">Ù…Ø­Ø§Ø³Ø¨Ù‡</a>
            </div>

            <!-- Ú©Ø§Ø±Øª Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ ØªÙ„ÙØ§Øª -->
            <div class="card">
                <div class="card-icon">ğŸ“‰</div>
                <h2>Ø¯Ø±ØµØ¯ ØªÙ„ÙØ§Øª</h2>
                <p>Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªÙ„ÙØ§Øª Ùˆ Ù‡Ø²ÛŒÙ†Ù‡ Ù‡Ø§ÛŒ Ù†Ø§Ø´ÛŒ Ø§Ø² Ø¢Ù†</p>
                <a href="pages/mortality-calculator.html" class="btn">Ù…Ø­Ø§Ø³Ø¨Ù‡</a>
            </div>

            <!-- Ú©Ø§Ø±Øª Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ Ø¯Ø§Ù†Ø®ÙˆØ±ÛŒ -->
            <div class="card">
                <div class="card-icon">âš–ï¸</div>
                <h2>Ø³Ø±Ø§Ù†Ù‡ Ù…ØµØ±Ù Ø¯Ø§Ù†</h2>
                <p>Ø¨Ø±Ø±Ø³ÛŒ Ù…ØµØ±Ù Ø¯Ø§Ù† Ù†Ø³Ø¨Øª Ø¨Ù‡ ÙˆØ²Ù† Ù¾Ø±Ù†Ø¯Ù‡</p>
                <a href="pages/feed-conversion.html" class="btn">Ù…Ø­Ø§Ø³Ø¨Ù‡</a>
            </div>

            <!-- Ú©Ø§Ø±Øª Ù…Ø§Ø´ÛŒÙ† Ø­Ø³Ø§Ø¨ ØªÙ†Ø¸ÛŒÙ… Ø¯ÙˆØ± ÙÙ† -->
            <div class="card">
                <div class="card-icon">ğŸŒ€</div>
                <h2>ØªÙ†Ø¸ÛŒÙ… Ø¯ÙˆØ± ÙÙ† (ØªÙ‡ÙˆÛŒÙ‡)</h2>
                <p>Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªÙ‡ÙˆÛŒÙ‡ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ùˆ ØªÙ†Ø¸ÛŒÙ… Ø¯ÙˆØ± ÙÙ†</p>
                <a href="pages/fan-calculator.html" class="btn">Ù…Ø­Ø§Ø³Ø¨Ù‡ ØªÙ‡ÙˆÛŒÙ‡</a>
            </div>

            <!-- Ú©Ø§Ø±Øª Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡ -->
            <div class="card">
                <div class="card-icon">ğŸ“‹</div>
                <h2>Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡</h2>
                <p>Ø«Ø¨Øª ÙˆÙ‚Ø§ÛŒØ¹ Ø±ÙˆØ²Ø§Ù†Ù‡ØŒ Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ùˆ Ù†Ù…ÙˆØ¯Ø§Ø± Ø±Ø´Ø¯</p>
                <a href="pages/daily-report.html" class="btn">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú¯Ø²Ø§Ø±Ø´</a>
            </div>
        </div>

        <!-- Ø¬Ø¯ÙˆÙ„ Ø«Ø¨Øª Ø¯Ø§Ø¯Ù‡Ù‡Ø§ -->
        <div class="data-table-section">
            <h2>ğŸ“‹ Ø«Ø¨Øª Ø¯Ø§Ø¯Ù‡Ù‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡</h2>
            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Ø±ÙˆØ² Ù¾Ø±ÙˆØ±Ø´</th>
                            <th>ØªØ§Ø±ÛŒØ® (Ø´Ù…Ø³ÛŒ)</th>
                            <th>ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ù†Ø¯Ù‡</th>
                            <th>ÙˆØ²Ù† (Ú¯Ø±Ù…)</th>
                            <th>Ø¯Ø§Ù† Ù…ØµØ±ÙÛŒ (Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…)</th>
                            <th>ØªÙ„ÙØ§Øª</th>
                            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Ø±Ø¯ÛŒÙÙ‡Ø§ Ø¨Ø§ JavaScript Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒØ´ÙˆÙ†Ø¯ -->
                    </tbody>
                </table>
            </div>

            <div class="table-controls">
                <button class="btn btn-success" onclick="addRow()">â• Ø§ÙØ²ÙˆØ¯Ù† Ø±Ø¯ÛŒÙ</button>
                <button class="btn btn-primary" onclick="calculateAll()">ğŸ“Š Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</button>
                <button class="btn btn-danger" onclick="resetTable()">ğŸ”„ Ø±ÛŒØ³Øª Ø¬Ø¯ÙˆÙ„</button>
            </div>

            <!-- Ù†ØªØ§ÛŒØ¬ Ù…Ø­Ø§Ø³Ø¨Ø§Øª -->
            <div class="results-section" id="resultsSection">
                <h3>Ù†ØªØ§ÛŒØ¬ Ù…Ø­Ø§Ø³Ø¨Ø§Øª</h3>
                <div class="results-grid" id="resultsGrid">
                    <!-- Ù†ØªØ§ÛŒØ¬ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒØ´ÙˆØ¯ -->
                </div>
            </div>
        </div>

        <!-- Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯: Ú†Øª Ø¨Ø§Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ -->
        <div class="chat-section">
            <h2>ğŸ¤– Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù…Ø±ØºØ¯Ø§Ø±ÛŒ</h2>
            <div class="chat-controls">
                <button class="clear-btn" id="clearChatBtn">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡</button>
            </div>
            <div class="chat-container" id="chatContainer">
                <!-- Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ Ø¨Ø§ Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
            </div>
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="Ø³ÙˆØ§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù¾Ø±Ø³ÛŒØ¯ (Ù…Ø«Ù„Ø§Ù‹: Ø¶Ø±ÛŒØ¨ ØªØ¨Ø¯ÛŒÙ„ Ú†Ú¯ÙˆÙ†Ù‡ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŸ)" autocomplete="off">
                <button id="sendBtn">Ø§Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

    <footer>
        <p>ØªÙ…Ø§Ù…ÛŒ Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸ Ø§Ø³Øª Â© Û±Û´Û°Û´</p>
    </footer>

    <script src="js/calculator.js"></script>
    <script>
        // ØªÙˆØ§Ø¨Ø¹ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ (Ù…Ø·Ø§Ø¨Ù‚ Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ Ø´Ù…Ø§)
        function getTodayJalali() {
            const today = new Date();
            const j = gregorianToJalali(today.getFullYear(), today.getMonth() + 1, today.getDate());
            return `${j.jy}/${j.jm.toString().padStart(2, '0')}/${j.jd.toString().padStart(2, '0')}`;
        }

        function gregorianToJalali(gy, gm, gd) {
            let g_days_in_month = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
            let j_days_in_month = [31, 31, 31, 31, 31, 31, 30, 30, 30, 30, 30, 29];

            let gy2 = (gm > 2) ? (gy + 1) : gy;
            let days = 365 * (gy + 1) + Math.floor((gy2 - 1) / 4) - Math.floor((gy2 - 1) / 100) + Math.floor((gy2 - 1) / 400);

            for (let i = 0; i < gm - 1; i++) {
                if (i === 1 && ((gy % 4 === 0 && gy % 100 !== 0) || gy % 400 === 0)) {
                    days += 29;
                } else {
                    days += g_days_in_month[i];
                }
            }
            days += gd;

            let jy = 979;
            let jm = 1;
            let jd = 1;

            days -= 226896;

            while (days >= (365 * 4 + 1) * 4) {
                days -= (365 * 4 + 1) * 4;
                jy += 4;
            }

            while (days >= 365) {
                if ((jy % 4 === 2 && jy % 128 !== 0) || (jy % 1320 === 3)) {
                    days -= 366;
                } else {
                    days -= 365;
                }
                jy++;
            }

            while (days >= j_days_in_month[jm - 1]) {
                days -= j_days_in_month[jm - 1];
                jm++;
            }

            jd = days + 1;

            return { jy, jm, jd };
        }

        // Ú©Ø¯ Ú†Øª Ø¨Ø§Øª (Ø¨Ø§ ÙØ±Ø¶ ÙˆØ¬ÙˆØ¯ Worker Ù…Ø´Ø§Ø¨Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ù‚Ø¨Ù„ÛŒ)
        document.addEventListener('DOMContentLoaded', function() {
            // Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ
            document.getElementById('jalaliDate').textContent = getTodayJalali();

            // ==================== Ø¨Ø®Ø´ Ú†Øª Ø¨Ø§Øª ====================
            const WORKER_URL = 'https://invoice-proxy.alef-adham.workers.dev'; // Ù‡Ù…Ø§Ù† Worker Ù‚Ø¨Ù„ÛŒ (Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯)
            const MODEL = 'deepseek-chat';
            const MAX_TOKENS = 2000;
            const TEMPERATURE = 0.7;

            let messages = [
                { role: 'assistant', content: 'Ø³Ù„Ø§Ù…! Ù…Ù† Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù…Ø±ØºØ¯Ø§Ø±ÛŒ Ù‡Ø³ØªÙ…. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø³ÙˆØ§Ù„Ø§Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ù…Ø±ØºØ¯Ø§Ø±ÛŒØŒ FCRØŒ ØªÙ„ÙØ§ØªØŒ ØªÙ‡ÙˆÛŒÙ‡ Ùˆ ... Ø¨Ù¾Ø±Ø³ÛŒØ¯.' }
            ];

            const chatContainer = document.getElementById('chatContainer');
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const clearBtn = document.getElementById('clearChatBtn');

            function renderMessages() {
                chatContainer.innerHTML = '';
                messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.role === 'user' ? 'user-message' : 'assistant-message'}`;

                    const bubble = document.createElement('div');
                    bubble.className = 'message-bubble';
                    bubble.textContent = msg.content;

                    messageDiv.appendChild(bubble);
                    chatContainer.appendChild(messageDiv);
                });
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            function addMessage(role, content) {
                messages.push({ role, content });
                renderMessages();
            }

            function showLoading() {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'loading';
                loadingDiv.id = 'chatLoadingIndicator';
                loadingDiv.innerHTML = '<div class="spinner"></div><span>Ø¯Ø± Ø­Ø§Ù„ ÙÚ©Ø± Ú©Ø±Ø¯Ù†...</span>';
                chatContainer.appendChild(loadingDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            function hideLoading() {
                const loading = document.getElementById('chatLoadingIndicator');
                if (loading) loading.remove();
            }

            async function sendMessage() {
                const userMessage = messageInput.value.trim();
                if (!userMessage) return;

                sendBtn.disabled = true;
                messageInput.disabled = true;

                addMessage('user', userMessage);
                messageInput.value = '';

                showLoading();

                try {
                    const apiMessages = messages.map(m => ({ role: m.role, content: m.content }));

                    const response = await fetch(WORKER_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: MODEL,
                            messages: apiMessages,
                            max_tokens: MAX_TOKENS,
                            temperature: TEMPERATURE
                        })
                    });

                    const data = await response.json();

                    if (data.error) {
                        let errorMessage = data.error;
                        if (data.details) {
                            try {
                                const details = JSON.parse(data.details);
                                errorMessage = details.error?.message || details.message || JSON.stringify(details);
                            } catch {
                                errorMessage = data.details;
                            }
                        }
                        throw new Error(errorMessage);
                    }

                    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                        throw new Error('Ù¾Ø§Ø³Ø® Ø§Ø² Ø³Ø±ÙˆØ± Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø³ØªÛŒ Ù†Ø¯Ø§Ø±Ø¯');
                    }

                    const assistantContent = data.choices[0].message.content;

                    hideLoading();
                    addMessage('assistant', assistantContent);

                } catch (error) {
                    hideLoading();
                    addMessage('assistant', `âŒ Ø®Ø·Ø§: ${error.message}`);
                } finally {
                    sendBtn.disabled = false;
                    messageInput.disabled = false;
                    messageInput.focus();
                }
            }

            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !sendBtn.disabled) {
                    sendMessage();
                }
            });

            clearBtn.addEventListener('click', () => {
                messages = [
                    { role: 'assistant', content: 'Ø³Ù„Ø§Ù…! Ù…Ù† Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù…Ø±ØºØ¯Ø§Ø±ÛŒ Ù‡Ø³ØªÙ…. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø³ÙˆØ§Ù„Ø§Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ù…Ø±ØºØ¯Ø§Ø±ÛŒØŒ FCRØŒ ØªÙ„ÙØ§ØªØŒ ØªÙ‡ÙˆÛŒÙ‡ Ùˆ ... Ø¨Ù¾Ø±Ø³ÛŒØ¯.' }
                ];
                renderMessages();
            });

            renderMessages();
            messageInput.focus();
        });
    </script>
</body>
</html>
