    <script src="js/calculator.js"></script>
    <script>
        // ==================== تنظیمات امن با پروکسی ====================
        // ✅ این نسخه امن است - کلید API در مرورگر دیده نمی‌شود
        // آدرس Worker پروکسی شما - بعد از دیپلوی، این آدرس را جایگزین کنید
        const WORKER_URL = 'https://your-worker.your-username.workers.dev'; // ⚠️ این خط را بعداً تغییر دهید

        // توابع تاریخ شمسی (مطابق کد قبلی)
        function getTodayJalali() {
            const today = new Date();
            const j = gregorianToJalali(today.getFullYear(), today.getMonth() + 1, today.getDate());
            return `${j.jy}/${j.jm.toString().padStart(2, '0')}/${j.jd.toString().padStart(2, '0')}`;
        }

        // ==================== کد اصلی ====================
        document.addEventListener('DOMContentLoaded', function() {
            // نمایش تاریخ شمسی
            document.getElementById('jalaliDate').textContent = getTodayJalali();

            // ========== بخش چت بات ==========
            let messages = [
                { role: 'assistant', content: 'سلام! من دستیار هوشمند مرغداری هستم. میتوانید سوالات خود را در مورد محاسبات مرغداری، FCR، تلفات، تهویه و ... بپرسید.' }
            ];

            const chatContainer = document.getElementById('chatContainer');
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const clearBtn = document.getElementById('clearChatBtn');

            function renderMessages() {
                chatContainer.innerHTML = '';
                messages.forEach(msg => {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.role === 'user' ? 'user-message' : 'assistant-message'}`;
                    const bubble = document.createElement('div');
                    bubble.className = 'message-bubble';
                    bubble.textContent = msg.content;
                    messageDiv.appendChild(bubble);
                    chatContainer.appendChild(messageDiv);
                });
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            function addMessage(role, content) {
                messages.push({ role, content });
                renderMessages();
            }

            function showLoading() {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'loading';
                loadingDiv.id = 'chatLoadingIndicator';
                loadingDiv.innerHTML = '<div class="spinner"></div><span>در حال فکر کردن...</span>';
                chatContainer.appendChild(loadingDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            function hideLoading() {
                const loading = document.getElementById('chatLoadingIndicator');
                if (loading) loading.remove();
            }

            async function sendMessage() {
                const userMessage = messageInput.value.trim();
                if (!userMessage) return;

                sendBtn.disabled = true;
                messageInput.disabled = true;

                addMessage('user', userMessage);
                messageInput.value = '';

                showLoading();

                try {
                    const apiMessages = messages.map(m => ({ role: m.role, content: m.content }));

                    // درخواست به Worker پروکسی (نه مستقیم به OpenRouter)
                    const response = await fetch(WORKER_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: 'meituan/longcat-flash-chat',
                            messages: apiMessages,
                            max_tokens: 2000,
                            temperature: 0.7
                        })
                    });

                    const data = await response.json();

                    if (data.error) {
                        throw new Error(data.error.message || JSON.stringify(data.error));
                    }

                    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                        throw new Error('پاسخ از سرور ساختار درستی ندارد');
                    }

                    const assistantContent = data.choices[0].message.content;
                    hideLoading();
                    addMessage('assistant', assistantContent);

                } catch (error) {
                    hideLoading();
                    addMessage('assistant', `❌ خطا: ${error.message}`);
                    console.error('جزئیات خطا:', error);
                } finally {
                    sendBtn.disabled = false;
                    messageInput.disabled = false;
                    messageInput.focus();
                }
            }

            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !sendBtn.disabled) {
                    sendMessage();
                }
            });

            clearBtn.addEventListener('click', () => {
                messages = [
                    { role: 'assistant', content: 'سلام! من دستیار هوشمند مرغداری هستم. میتوانید سوالات خود را در مورد محاسبات مرغداری، FCR، تلفات، تهویه و ... بپرسید.' }
                ];
                renderMessages();
            });

            renderMessages();
            messageInput.focus();
        });
    </script>
